from pydantic import BaseModel, Field, field_validator
from typing import List, Optional, Dict, Union
from pathlib import Path

class Justification(BaseModel):
    """A model to hold a single reason for the decision, tied to a specific clause."""
    clause: str = Field(description="The specific clause or rule from the document that this reason is based on.")
    reason: str = Field(description="A simple, one-sentence explanation of how this clause applies to the user's query.")

class query(BaseModel):
    age: Optional[int] = Field(None, description="Age of the person making the claim.")
    procedure: Optional[str] = Field(None, description="Medical procedure or query related to the claim.")
    Location: Optional[str] = Field(None, description="Location of the claimant.")
    duration: Optional[str] = Field(None, description="Duration or validity period of the insurance policy.")

class PolicyDecision(BaseModel):
    """The final, structured decision for an insurance claim."""
    decision: str = Field(
        description="The final decision: Approved, Rejected, or Pending.",
        enum=["Approved", "Rejected", "Pending"])
    approved_amount: Union[int, str] = Field(description="The final approved payout amount in USD. Should be 'NA' if the claim is not approved or if no specific amount is mentioned.")
    justification: List[Justification] = Field(description="A list of all clauses and reasons that support the final decision.")

class state(BaseModel):
    input: Optional[str] = Field(default=None, description="User's text input query.")
    file_path: Optional[Path] = Field(default=None, description="Path to the uploaded PDF or TXT document.")
    rag_ans: Optional[str] = Field(default=None, description="Response generated by the Retrieval-Augmented Generation (RAG) agent.")
    source: Optional[List[str]] = Field(default=None, description="Sources used to generate the RAG response.")
    url: Optional[Path] = Field(default=None, description="Cloudinary URL of the stored database or index file.")
    question: Optional[query] = Field(default=None, description="Structured and formatted version of the user's query.")
    
    @field_validator("file_path", mode="before")
    @classmethod
    def normalize_path(cls, v):
        if isinstance(v, str):
            return Path(v.replace("\\", "/"))
        return v